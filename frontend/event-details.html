<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è - Match Day Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .event-header {
            background: linear-gradient(120deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            padding: 80px 0 40px;
            margin-bottom: 40px;
        }

        .event-image {
            height: 300px;
            object-fit: cover;
            border-radius: 10px;
        }

        .organizer-card {
            transition: transform 0.3s;
        }

        .organizer-card:hover {
            transform: translateY(-5px);
        }

        .participate-btn {
            font-size: 1.2rem;
            padding: 10px 20px;
        }
    </style>
</head>

<body>
    <!-- –®–∞–ø–∫–∞ -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="logo.jpg" alt="MDS" height="60">
            </a>
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="my_events.html">–ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
                    </li>
                </ul>

                <!-- –ü–æ–∏—Å–∫ –∏ –ø—Ä–æ—Ñ–∏–ª—å -->
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle d-flex align-items-center" type="button"
                            data-bs-toggle="dropdown">
                            <img src="Person.svg" class="me-2" width="32" height="32" alt="–ü—Ä–æ—Ñ–∏–ª—å">
                            <span id="headerUserName">–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a></li>
                            <li><a class="dropdown-item" href="my_events.html">–ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a></li>
                            <li><a class="dropdown-item" href="settings.html">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="#" id="logoutLink">–í—ã–π—Ç–∏</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- –®–∞–ø–∫–∞ —Å–æ–±—ã—Ç–∏—è -->
    <div class="event-header">
        <div class="container text-center">
            <h1 id="eventTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            <div class="mt-3">
                <span id="eventSportBadge" class="badge bg-primary fs-6">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                <span id="eventTypeBadge" class="badge bg-info fs-6">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p id="eventDateTime" class="lead mt-3">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏...</p>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="container mb-5">
        <div class="row">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-body">
                        <h3 class="card-title mb-4">–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                        <p id="eventDescription" class="fs-5">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è...</p>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h3 class="mb-0">–î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span><i class="bi bi-calendar me-2"></i>–î–∞—Ç–∞:</span>
                                        <span id="eventDate">-</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span><i class="bi bi-clock me-2"></i>–í—Ä–µ–º—è:</span>
                                        <span id="eventTime">-</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span><i class="bi bi-cash-coin me-2"></i>–¶–µ–Ω–∞:</span>
                                        <span id="eventPrice">-</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span><i class="bi bi-people me-2"></i>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</span>
                                        <span id="eventParticipants">-</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span><i class="bi bi-person-plus me-2"></i>–í–æ–∑—Ä–∞—Å—Ç:</span>
                                        <span id="eventAgeRestriction">-</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span><i class="bi bi-geo-alt me-2"></i>–ú–µ—Å—Ç–æ:</span>
                                        <span id="eventLocation">-</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h3 class="mb-0">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h3>
                    </div>
                    <div class="card-body p-0">
                        <div id="map" style="height: 300px; background: #f0f0f0; border-radius: 0 0 10px 10px;">
                            <div class="d-flex justify-content-center align-items-center h-100">
                                <div class="text-center">
                                    <i class="bi bi-map display-1 text-secondary"></i>
                                    <p class="mt-2">–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="col-lg-4">
                <div class="card mb-4 organizer-card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <img src="Person.svg" alt="–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä" width="60" height="60" class="rounded-circle">
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 id="organizerName">–ó–∞–≥—Ä—É–∑–∫–∞...</h6>
                                <p class="text-muted mb-0">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä —Å–æ–±—ã—Ç–∏—è</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">–£—á–∞—Å—Ç–∏–µ</h5>
                    </div>
                    <div class="card-body text-center">
                        <button id="participateBtn" class="btn btn-primary participate-btn w-100 mb-3">
                            <i class="bi bi-check-circle me-2"></i> –ü—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ
                        </button>
                        <div class="progress mb-3">
                            <div id="participantsProgress" class="progress-bar" role="progressbar"></div>
                        </div>
                        <p class="text-muted">
                            <span id="availableSpots">0</span> –∏–∑ <span id="maxParticipants">0</span> –º–µ—Å—Ç —Å–≤–æ–±–æ–¥–Ω–æ
                        </p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">–î–µ–π—Å—Ç–≤–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-outline-secondary w-100 mb-2">
                            <i class="bi bi-share me-2"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                        </button>
                        <button class="btn btn-outline-secondary w-100">
                            <i class="bi bi-calendar-plus me-2"></i> –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –§—É—Ç–µ—Ä (—Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –Ω–∞ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö) -->
    <footer class="bg-dark text-white py-4">
        <!-- ... –≤–∞—à –∫–æ–¥ —Ñ—É—Ç–µ—Ä–∞ ... -->
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Å–æ–±—ã—Ç–∏—è
        async function loadEventDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');

            if (!eventId) {
                showError('–°–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }

            try {
                const response = await fetch(`/api/events/${eventId}`);
                if (!response.ok) throw new Error('–°–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');

                const event = await response.json();
                renderEventDetails(event);
            } catch (error) {
                showError(error.message);
            }
        }

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞—Ç—ã
        function createEventDate(event) {

            // –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—É—é –¥–∞—Ç—É –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
            const datePart = new Date(event.event_date);

            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
            if (isNaN(datePart.getTime())) return null;

            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è
            const [hours, minutes] = event.event_time.split(':');
            datePart.setHours(parseInt(hours, 10));
            datePart.setMinutes(parseInt(minutes, 10));

            return datePart;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π —Å–æ–±—ã—Ç–∏—è
        function renderEventDetails(event) {
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
            const eventDate = createEventDate(event);
            let formattedDate = event.event_date;
            let formattedTime = event.event_time.substring(0, 5);

            if (eventDate) {
                formattedDate = eventDate.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                formattedTime = eventDate.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // –ò–∫–æ–Ω–∫–∏ –¥–ª—è –≤–∏–¥–æ–≤ —Å–ø–æ—Ä—Ç–∞
            const sportIcons = {
                running: 'üèÉ –ë–µ–≥',
                cycling: 'üö¥ –í–µ–ª–æ—Å–ø–æ—Ä—Ç',
                football: '‚öΩ –§—É—Ç–±–æ–ª',
                basketball: 'üèÄ –ë–∞—Å–∫–µ—Ç–±–æ–ª',
                tennis: 'üéæ –¢–µ–Ω–Ω–∏—Å',
                volleyball: 'üèê –í–æ–ª–µ–π–±–æ–ª',
                swimming: 'üèä –ü–ª–∞–≤–∞–Ω–∏–µ',
                yoga: 'üßò –ô–æ–≥–∞'
            };

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É
            const price = parseFloat(event.price);
            const priceText = price > 0 ? `${price.toFixed(2)} ‚ÇΩ` : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ';

            // –í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
            const ageText = event.age_restriction > 0 ? `${event.age_restriction}+` : '–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π';

            // –£—á–∞—Å—Ç–Ω–∏–∫–∏
            const maxParticipants = event.max_participants || '‚àû';
            const participants = event.participant_count || 0;
            const available = maxParticipants !== '‚àû' ? maxParticipants - participants : '‚àû';

            // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.getElementById('eventTitle').textContent = event.title;
            document.getElementById('eventSportBadge').textContent = sportIcons[event.sport_type] || event.sport_type;
            document.getElementById('eventTypeBadge').textContent = event.event_type;
            document.getElementById('eventDateTime').textContent = `${formattedDate}, ${formattedTime}`;
            document.getElementById('eventDescription').textContent = event.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';

            document.getElementById('eventDate').textContent = formattedDate;
            document.getElementById('eventTime').textContent = formattedTime;
            document.getElementById('eventPrice').textContent = priceText;
            document.getElementById('eventParticipants').textContent = `${participants} / ${maxParticipants}`;
            document.getElementById('eventAgeRestriction').textContent = ageText;
            document.getElementById('eventLocation').textContent = event.location;

            document.getElementById('organizerName').textContent = event.organizer_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä';

            document.getElementById('availableSpots').textContent = available;
            document.getElementById('maxParticipants').textContent = maxParticipants;

            // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            if (maxParticipants !== '‚àû' && maxParticipants > 0) {
                const progress = (participants / maxParticipants) * 100;
                const progressBar = document.getElementById('participantsProgress');
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${Math.round(progress)}%`;
                progressBar.classList.add(progress > 80 ? 'bg-danger' : 'bg-success');
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —É—á–∞—Å—Ç–∏—è
            document.getElementById('participateBtn').addEventListener('click', async () => {
                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) {
                        alert('–î–ª—è —É—á–∞—Å—Ç–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                        return;
                    }

                    const response = await fetch(`/api/events/${event.id}/participate`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        alert('–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –Ω–∞ —Å–æ–±—ã—Ç–∏–µ!');
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
                        loadEventDetails();
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è');
                    }
                } catch (error) {
                    alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
        function showError(message) {
            document.querySelector('.event-header').innerHTML = `
                <div class="container text-center">
                    <h1 class="text-danger">–û—à–∏–±–∫–∞</h1>
                    <p class="lead">${message}</p>
                    <a href="index.html" class="btn btn-primary mt-3">
                        <i class="bi bi-arrow-left me-2"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    </a>
                </div>
            `;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', loadEventDetails);
    </script>
</body>

</html>