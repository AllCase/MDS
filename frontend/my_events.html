<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои мероприятия - Match Day Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script>
        // Система защиты авторизации
        (function () {
            // Разрешенные страницы без авторизации
            const allowedPages = ['aut.html', 'reg.html'];
            const currentPage = window.location.pathname.split('/').pop() || 'index.html';

            const token = localStorage.getItem('authToken');
            const isLoggedIn = !!token;

            // Если пользователь не авторизован и пытается получить доступ к защищенной странице
            if (!isLoggedIn && !allowedPages.includes(currentPage)) {
                sessionStorage.setItem('redirectUrl', window.location.href);
                window.location.href = 'aut.html';
            }

            // Если пользователь авторизован и пытается получить доступ к странице входа/регистрации
            if (isLoggedIn && allowedPages.includes(currentPage)) {
                window.location.href = 'index.html';
            }
        })();
    </script>
    <style>
        .event-card {
            transition: transform 0.3s;
            border-radius: 15px;
            overflow: hidden;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .event-card:hover {
            transform: translateY(-5px);
        }

        .sport-icon {
            width: 32px;
            height: 32px;
        }

        .map-preview {
            height: 150px;
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            position: relative;
            overflow: hidden;
        }

        .category-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 2;
        }

        .status-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 2;
        }

        .participants-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            margin-left: -10px;
        }

        .tab-content {
            padding-top: 20px;
        }

        .organizer-badge {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
        }

        .participant-badge {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background-color: #f8f9fa;
            border-radius: 15px;
            margin-top: 20px;
        }

        .empty-state i {
            font-size: 5rem;
            color: #dee2e6;
            margin-bottom: 20px;
        }

        .filter-card {
            margin-bottom: 20px;
            margin-top: 20px;
        }

        .nav-pills .nav-link.active {
            background: linear-gradient(120deg, #1a2a6c, #b21f1f);
            color: white;
            box-shadow: 0 4px 10px rgba(26, 42, 108, 0.25);
        }

        .nav-pills .nav-link {
            border-radius: 20px;
            padding: 10px 20px;
            margin-bottom: 10px;
            color: #495057;
            font-weight: 500;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
    </style>
</head>

<body>
    <!-- Шапка -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="logo.jpg" alt="MDS" height="60">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Главная</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="my_events.html">Мои мероприятия</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Календарь</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle d-flex align-items-center" type="button"
                            data-bs-toggle="dropdown">
                            <img src="Person.svg" class="me-2" width="32" height="32" alt="Профиль">
                            <span id="headerUserName">Иван Петров</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html">Мой профиль</a></li>
                            <li><a class="dropdown-item active" href="my_events.html">Мои мероприятия</a></li>
                            <li><a class="dropdown-item" href="settings.html">Настройки</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="aut.html">Выйти</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <div class="container py-5">
        <!-- Заголовок и кнопки -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Мои мероприятия</h1>
            <div>
                <a href="index.html" class="btn btn-outline-primary me-2">
                    <i class="bi bi-arrow-left me-1"></i> На главную
                </a>
                <a href="create.html">
                    <button class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Создать событие
                    </button>
                </a>
            </div>
        </div>
        <!-- Вкладки -->
        <ul class="nav nav-tabs mb-4" id="eventsTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="participating-tab" data-bs-toggle="tab"
                    data-bs-target="#participating" type="button" role="tab">
                    <i class="bi bi-person-check me-1"></i> Участвую
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="organizing-tab" data-bs-toggle="tab" data-bs-target="#organizing"
                    type="button" role="tab">
                    <i class="bi bi-megaphone me-1"></i> Организую
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past" type="button"
                    role="tab">
                    <i class="bi bi-clock-history me-1"></i> Прошедшие
                </button>
            </li>
        </ul>
        <div class="tab-content" id="eventsTabContent">
            <!-- Вкладка "Участвую" -->
            <div class="tab-pane fade show active" id="participating" role="tabpanel">
                <div class="row">
                    <!-- Фильтры -->
                    <div class="col-lg-3 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <!-- Кнопка "На главную" в боковом меню -->
                                <a href="index.html" class="btn btn-outline-primary mb-3 w-100">
                                    <i class="bi bi-house-door me-1"></i> На главную
                                </a>

                                <ul class="nav nav-pills flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="profile.html"><i class="bi bi-person me-2"></i> Обзор
                                            профиля</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link active" href="my_events.html"><i
                                                class="bi bi-calendar-event me-2"></i> Мои
                                            мероприятия</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="settings.html"><i class="bi bi-gear me-2"></i>
                                            Настройки</a>
                                    </li>
                                    <li class="nav-item mt-3">
                                        <a class="nav-link text-danger" href="aut.html"><i
                                                class="bi bi-box-arrow-right me-2"></i>
                                            Выйти</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="card filter-card">
                            <div class="card-header bg-primary text-white">
                                Фильтры мероприятий
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Статус</label>
                                    <select class="form-select" id="statusFilter">
                                        <option value="all">Все</option>
                                        <option value="active" selected>Активные</option>
                                        <option value="completed">Завершённые</option>
                                        <option value="cancelled">Отменённые</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Дата</label>
                                    <select class="form-select" id="dateFilter">
                                        <option value="all">Любая</option>
                                        <option value="today">Сегодня</option>
                                        <option value="tomorrow">Завтра</option>
                                        <option value="week">На этой неделе</option>
                                        <option value="month">В этом месяце</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Вид спорта</label>
                                    <div class="form-check">
                                        <input class="form-check-input sport-filter" type="checkbox" value="running"
                                            id="running-filter" checked>
                                        <label class="form-check-label" for="running-filter">
                                            🏃 Бег
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input sport-filter" type="checkbox" value="cycling"
                                            id="cycling-filter" checked>
                                        <label class="form-check-label" for="cycling-filter">
                                            🚴 Велоспорт
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input sport-filter" type="checkbox" value="football"
                                            id="football-filter">
                                        <label class="form-check-label" for="football-filter">
                                            ⚽ Футбол
                                        </label>
                                    </div>
                                </div>

                                <button class="btn btn-primary w-100" id="applyFilters">Применить фильтры</button>
                            </div>
                        </div>
                    </div>

                    <!-- Список мероприятий -->
                    <div class="col-lg-9">
                        <div id="participatingEventsContainer" class="row row-cols-1 row-cols-md-2 g-4">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка "Организую" -->
            <div class="tab-pane fade" id="organizing" role="tabpanel">
                <div class="row">
                    <!-- Фильтры -->
                    <div class="col-lg-3 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <!-- Кнопка "На главную" в боковом меню -->
                                <a href="index.html" class="btn btn-outline-primary mb-3 w-100">
                                    <i class="bi bi-house-door me-1"></i> На главную
                                </a>

                                <ul class="nav nav-pills flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="profile.html"><i class="bi bi-person me-2"></i> Обзор
                                            профиля</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link active" href="my_events.html"><i
                                                class="bi bi-calendar-event me-2"></i> Мои
                                            мероприятия</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="settings.html"><i class="bi bi-gear me-2"></i>
                                            Настройки</a>
                                    </li>
                                    <li class="nav-item mt-3">
                                        <a class="nav-link text-danger" href="aut.html"><i
                                                class="bi bi-box-arrow-right me-2"></i>
                                            Выйти</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="card filter-card">
                            <div class="card-header bg-info text-white">
                                Фильтры мероприятий
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Статус</label>
                                    <select class="form-select" id="organizingStatusFilter">
                                        <option value="all">Все</option>
                                        <option value="active" selected>Активные</option>
                                        <option value="completed">Завершённые</option>
                                        <option value="cancelled">Отменённые</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Дата</label>
                                    <select class="form-select" id="organizingDateFilter">
                                        <option value="all">Любая</option>
                                        <option value="today">Сегодня</option>
                                        <option value="tomorrow">Завтра</option>
                                        <option value="week">На этой неделе</option>
                                        <option value="month">В этом месяце</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Тип мероприятия</label>
                                    <div class="form-check">
                                        <input class="form-check-input type-filter" type="checkbox" value="training"
                                            id="training-filter" checked>
                                        <label class="form-check-label" for="training-filter">
                                            Тренировки
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input type-filter" type="checkbox" value="competition"
                                            id="competition-filter">
                                        <label class="form-check-label" for="competition-filter">
                                            Соревнования
                                        </label>
                                    </div>
                                </div>

                                <button class="btn btn-info w-100 text-white" id="applyOrganizingFilters">Применить
                                    фильтры</button>
                            </div>
                        </div>
                    </div>

                    <!-- Список мероприятий -->
                    <div class="col-lg-9">
                        <div id="organizingEventsContainer" class="row row-cols-1 row-cols-md-2 g-4">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка "Прошедшие" -->
            <div class="tab-pane fade" id="past" role="tabpanel">
                <div class="row">
                    <!-- Фильтры -->
                    <div class="col-lg-3 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <!-- Кнопка "На главную" в боковом меню -->
                                <a href="index.html" class="btn btn-outline-primary mb-3 w-100">
                                    <i class="bi bi-house-door me-1"></i> На главную
                                </a>

                                <ul class="nav nav-pills flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="profile.html"><i class="bi bi-person me-2"></i> Обзор
                                            профиля</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link active" href="my_events.html"><i
                                                class="bi bi-calendar-event me-2"></i> Мои
                                            мероприятия</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="settings.html"><i class="bi bi-gear me-2"></i>
                                            Настройки</a>
                                    </li>
                                    <li class="nav-item mt-3">
                                        <a class="nav-link text-danger" href="aut.html"><i
                                                class="bi bi-box-arrow-right me-2"></i>
                                            Выйти</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="card filter-card">
                            <div class="card-header bg-secondary text-white">
                                Фильтры мероприятий
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Период</label>
                                    <select class="form-select" id="periodFilter">
                                        <option value="all">За всё время</option>
                                        <option value="month" selected>За последний месяц</option>
                                        <option value="3months">За последние 3 месяца</option>
                                        <option value="year">За последний год</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Роль</label>
                                    <select class="form-select" id="roleFilter">
                                        <option value="all">Все</option>
                                        <option value="participant">Участник</option>
                                        <option value="organizer">Организатор</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Вид спорта</label>
                                    <div class="form-check">
                                        <input class="form-check-input past-sport-filter" type="checkbox"
                                            value="running" id="past-running-filter" checked>
                                        <label class="form-check-label" for="past-running-filter">
                                            🏃 Бег
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input past-sport-filter" type="checkbox"
                                            value="cycling" id="past-cycling-filter" checked>
                                        <label class="form-check-label" for="past-cycling-filter">
                                            🚴 Велоспорт
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input past-sport-filter" type="checkbox"
                                            value="football" id="past-football-filter">
                                        <label class="form-check-label" for="past-football-filter">
                                            ⚽ Футбол
                                        </label>
                                    </div>
                                </div>

                                <button class="btn btn-secondary w-100" id="applyPastFilters">Применить фильтры</button>
                            </div>
                        </div>
                    </div>

                    <!-- Список мероприятий -->
                    <div class="col-lg-9">
                        <div id="pastEventsContainer" class="row row-cols-1 row-cols-md-2 g-4">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Футер -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <h5>Match Day Sync</h5>
                    <p>Платформа для организации спортивных мероприятий и поиска единомышленников.</p>
                </div>
                <div class="col-md-4 mb-3">
                    <h5>Контакты</h5>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-envelope me-2"></i> contact@MatchDaySync.ru</li>
                        <li><i class="bi bi-telephone me-2"></i> +7 (495) 123-45-67</li>
                    </ul>
                </div>
                <div class="col-md-4 mb-3">
                    <h5>Мы в соцсетях</h5>
                    <div class="d-flex gap-3">
                        <a href="#" class="text-white fs-4"><i class="bi bi-telegram"></i></a>
                        <a href="#" class="text-white fs-4"><i class="bi bi-vk"></i></a>
                    </div>
                </div>
            </div>
            <hr class="bg-light">
            <div class="text-center">
                <small>© 2025 Match Day Sync. Все права защищены.</small>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Функция для получения данных пользователя
        async function fetchUserData() {
            const token = localStorage.getItem('authToken');
            if (!token) return null;

            try {
                const response = await fetch('/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error('Ошибка получения данных пользователя:', error);
                return null;
            }
        }

        // Функция для получения мероприятий
        async function fetchEvents(endpoint) {
            const token = localStorage.getItem('authToken');
            console.log('Запрос к:', endpoint);
            console.log('Токен:', token ? 'Присутствует' : 'Отсутствует');

            if (!token) {
                console.error('Токен не найден');
                return [];
            }

            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Статус ответа:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Получены данные:', data);
                    return data;
                } else if (response.status === 401) {
                    console.error('Ошибка авторизации');
                    localStorage.removeItem('authToken');
                    window.location.href = 'aut.html';
                    return [];
                } else {
                    const errorText = await response.text();
                    console.error('Ошибка сервера:', response.status, errorText);
                    return [];
                }
            } catch (error) {
                console.error('Ошибка получения мероприятий:', error);
                return [];
            }
        }

        // Функция для форматирования даты
        function formatDate(dateString) {
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('ru-RU', options);
        }

        // Функция для отображения мероприятий
        function displayEvents(events, containerId, type) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (events.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="bi bi-calendar-x"></i>
                            <h4>Нет мероприятий</h4>
                            <p class="text-muted">${type === 'participating' ? 'Вы не участвуете в мероприятиях' : type === 'organizing' ? 'Вы не организуете мероприятия' : 'Нет прошедших мероприятий'}.</p>
                        </div>
                    </div>
                `;
                return;
            }

            let eventsHTML = '';
            events.forEach(event => {
                const eventDate = new Date(event.event_date);
                const now = new Date();
                const isPast = eventDate < now;

                eventsHTML += `
                    <div class="col">
                        <div class="card h-100 event-card">
                            <span class="status-badge badge ${type === 'organizing' ? 'organizer-badge' : 'participant-badge'}">
                                ${type === 'organizing' ? 'Организатор' : 'Участник'}
                            </span>
                            <span class="category-badge badge ${event.price > 0 ? 'bg-warning text-dark' : 'bg-danger'}">
                                ${event.price > 0 ? event.price + ' ₽' : 'Бесплатно'}
                            </span>
                            <div class="map-preview"></div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title">${event.title}</h5>
                                    <img src="${event.sport_type}.svg" class="sport-icon" alt="${event.sport_type}">
                                </div>
                                <p class="card-text">
                                    <i class="bi bi-calendar"></i> ${formatDate(event.event_date)}, ${event.event_time}<br>
                                    <i class="bi bi-geo-alt"></i> ${event.location}<br>
                                    <i class="bi bi-people"></i> ${event.max_participants ? event.max_participants + ' участников' : 'Неограничено'}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex">
                                        <span class="badge bg-light text-dark me-2">
                                            <i class="bi bi-tag me-1"></i> ${event.event_type === 'training' ? 'Тренировка' : 'Соревнование'}
                                        </span>
                                        <span class="badge ${isPast ? 'bg-secondary' : 'bg-success'}">
                                            ${isPast ? 'Завершено' : 'Активно'}
                                        </span>
                                    </div>
                                    ${type === 'organizing' ? `
                                    <div>
                                        <button class="btn btn-outline-primary btn-sm me-2" onclick="editEvent(${event.id})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteEvent(${event.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    ` : `
                                    <button class="btn btn-outline-danger btn-sm" onclick="leaveEvent(${event.id})">
                                        ${isPast ? 'Удалить из истории' : 'Отменить участие'}
                                    </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = eventsHTML;
        }

        // Функция для загрузки мероприятий, в которых пользователь участвует
        async function loadParticipatingEvents() {
            const container = document.getElementById('participatingEventsContainer');
            container.innerHTML = '<div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';

            const events = await fetchEvents('/api/events/participating');
            displayEvents(events, 'participatingEventsContainer', 'participating');
        }

        // Функция для загрузки мероприятий, которые пользователь организует
        async function loadOrganizingEvents() {
            console.log('Загрузка организуемых мероприятий...');
            const container = document.getElementById('organizingEventsContainer');
            container.innerHTML = '<div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';

            try {
                const events = await fetchEvents('/api/events/organizing');
                console.log('Получены организуемые мероприятия:', events);
                displayEvents(events, 'organizingEventsContainer', 'organizing');
            } catch (error) {
                console.error('Ошибка загрузки организуемых мероприятий:', error);
                // Показываем сообщение об ошибке
                container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    Ошибка загрузки мероприятий: ${error.message}
                </div>
            </div>
        `;
            }
        }

        // Функция для загрузки прошедших мероприятий
        async function loadPastEvents() {
            const container = document.getElementById('pastEventsContainer');
            container.innerHTML = '<div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';

            const events = await fetchEvents('/api/events/past');
            displayEvents(events, 'pastEventsContainer', 'past');
        }

        // Функции для работы с мероприятиями
        async function leaveEvent(eventId) {
            if (!confirm('Вы уверены, что хотите отменить участие в этом мероприятии?')) return;

            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`/api/events/${eventId}/participate`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('Участие отменено');
                    loadParticipatingEvents();
                } else {
                    alert('Ошибка при отмене участия');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка при отмене участия');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Вы уверены, что хотите удалить это мероприятие?')) return;

            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('Мероприятие удалено');
                    loadOrganizingEvents();
                } else {
                    alert('Ошибка при удалении мероприятия');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка при удалении мероприятия');
            }
        }

        function editEvent(eventId) {
            window.location.href = `create.html?edit=${eventId}`;
        }

        // После загрузки страницы
        document.addEventListener('DOMContentLoaded', async function () {
            // Проверяем, авторизован ли пользователь
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'aut.html';
                return;
            }

            // Получаем данные пользователя
            const user = await fetchUserData();
            if (user) {
                // Обновляем имя в шапке
                const headerUserName = document.getElementById('headerUserName');
                if (headerUserName) {
                    headerUserName.textContent = user.full_name || 'Пользователь';
                }
            }

            // Загружаем мероприятия для активной вкладки
            loadParticipatingEvents();

            // Обработка переключения вкладок
            const participatingTab = document.getElementById('participating-tab');
            const organizingTab = document.getElementById('organizing-tab');
            const pastTab = document.getElementById('past-tab');

            if (participatingTab) {
                participatingTab.addEventListener('shown.bs.tab', function () {
                    loadParticipatingEvents();
                });
            }

            if (organizingTab) {
                organizingTab.addEventListener('shown.bs.tab', function () {
                    loadOrganizingEvents();
                });
            }

            if (pastTab) {
                pastTab.addEventListener('shown.bs.tab', function () {
                    loadPastEvents();
                });
            }

            // Обработка выхода из системы
            const logoutBtn = document.querySelector('.dropdown-item.text-danger');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    localStorage.removeItem('authToken');
                    window.location.href = 'aut.html';
                });
            }

            // Обработка фильтров
            document.getElementById('applyFilters')?.addEventListener('click', function () {
                loadParticipatingEvents();
            });

            document.getElementById('applyOrganizingFilters')?.addEventListener('click', function () {
                loadOrganizingEvents();
            });

            document.getElementById('applyPastFilters')?.addEventListener('click', function () {
                loadPastEvents();
            });
        });
    </script>
</body>

</html>